# 03 - Token YÃ¶netimi

## ğŸ’° Token Maliyeti HesaplamasÄ±

### Gemini 2.0 Flash FiyatlandÄ±rmasÄ± (2026)

| Metrik | Fiyat (USD) | Fiyat (TRY) |
|--------|-------------|-------------|
| Input (1M token) | $0.075 | ~â‚º2.85 |
| Output (1M token) | $0.30 | ~â‚º11.40 |

### Ortalama Belge Maliyeti

```
TIPIK BELGE ANALÄ°ZÄ°:
â”œâ”€â”€ Input Tokens
â”‚   â”œâ”€â”€ Sistem Prompt: ~1.500 token
â”‚   â”œâ”€â”€ Belge Ä°Ã§eriÄŸi: ~2.000 token (PDF metin)
â”‚   â””â”€â”€ Pattern Hint:  ~500 token
â”‚   â””â”€â”€ TOPLAM INPUT:  ~4.000 token
â”‚
â””â”€â”€ Output Tokens
    â””â”€â”€ JSON YanÄ±t:    ~800 token
    â””â”€â”€ TOPLAM OUTPUT: ~800 token

MALÄ°YET:
â”œâ”€â”€ Input:  4.000 Ã— $0.000000075 = $0.0003
â”œâ”€â”€ Output: 800 Ã— $0.00000030   = $0.00024
â””â”€â”€ TOPLAM: $0.00054 â‰ˆ â‚º0.02

GÃœNLÃœK 100 BELGE: â‚º2.00
AYLIK 2.000 BELGE: â‚º40.00
```

---

## ğŸ“Š Token Loglama AkÄ±ÅŸÄ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DESKTOP APP                                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ DocumentFlowâ”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚         â”‚ 1. Analiz isteÄŸi                                      â”‚
â”‚         â”‚    { license_id, content, filename }                  â”‚
â”‚         â–¼                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ HTTPS POST /api/v1/ai/analyze
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND                                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Auth        â”‚â”€â”€â”€â”€â–ºâ”‚ Quota Check â”‚â”€â”€â”€â”€â–ºâ”‚ Gemini Call â”‚       â”‚
â”‚  â”‚ Middleware  â”‚     â”‚             â”‚     â”‚             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                  â”‚              â”‚
â”‚         2. Lisans doÄŸrula                        â”‚              â”‚
â”‚         3. Kota kontrol                          â”‚              â”‚
â”‚                                                  â–¼              â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                                          â”‚ Gemini API  â”‚       â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                 â”‚               â”‚
â”‚                                                 â”‚ Response      â”‚
â”‚                                                 â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    TOKEN LOGGER                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  4. KayÄ±t oluÅŸtur:                                       â”‚   â”‚
â”‚  â”‚  {                                                       â”‚   â”‚
â”‚  â”‚    "id": "log_1707091200_abc123",                        â”‚   â”‚
â”‚  â”‚    "license_id": "DMZ-xyz",                              â”‚   â”‚
â”‚  â”‚    "timestamp": "2026-02-05T01:40:00Z",                  â”‚   â”‚
â”‚  â”‚    "operation": "document_analysis",                     â”‚   â”‚
â”‚  â”‚    "tokens": {                                           â”‚   â”‚
â”‚  â”‚      "input": 4200,                                      â”‚   â”‚
â”‚  â”‚      "output": 850,                                      â”‚   â”‚
â”‚  â”‚      "total": 5050                                       â”‚   â”‚
â”‚  â”‚    },                                                    â”‚   â”‚
â”‚  â”‚    "cost_usd": 0.00057,                                  â”‚   â”‚
â”‚  â”‚    "document_type": "banka-dekontu",                     â”‚   â”‚
â”‚  â”‚    "success": true                                       â”‚   â”‚
â”‚  â”‚  }                                                       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  5. Dosyaya append: /usage/2026-02/DMZ-xyz.jsonl        â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ Usage Cache â”‚  6. Cache gÃ¼ncelle (Redis/Memory)             â”‚
â”‚  â”‚ (Redis)     â”‚     current_month_usage += 5050               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Log Dosya FormatÄ±

### Konum
```
/var/lib/domizan/usage/{YYYY-MM}/{license_id}.jsonl
```

### Format (JSON Lines)
```jsonl
{"id":"log_1707091200_a1","ts":"2026-02-05T01:40:00Z","op":"analyze","in":4200,"out":850,"cost":0.00057,"doc":"banka-dekontu","ok":true}
{"id":"log_1707091260_b2","ts":"2026-02-05T01:41:00Z","op":"analyze","in":3800,"out":720,"cost":0.00050,"doc":"fatura","ok":true}
{"id":"log_1707091320_c3","ts":"2026-02-05T01:42:00Z","op":"analyze","in":5100,"out":900,"cost":0.00065,"doc":"beyanname","ok":true}
```

### GÃ¼nlÃ¼k Ã–zet
```json
// /usage/2026-02/DMZ-xyz_summary.json
{
  "license_id": "DMZ-xyz",
  "period": "2026-02",
  "totals": {
    "requests": 2450,
    "input_tokens": 9800000,
    "output_tokens": 1960000,
    "total_tokens": 11760000,
    "cost_usd": 1.23,
    "cost_try": 46.74
  },
  "by_day": {
    "2026-02-01": { "requests": 85, "tokens": 425000 },
    "2026-02-02": { "requests": 92, "tokens": 460000 }
  },
  "by_type": {
    "banka-dekontu": { "count": 450, "tokens": 2250000 },
    "fatura": { "count": 820, "tokens": 4100000 },
    "beyanname": { "count": 380, "tokens": 2280000 }
  }
}
```

---

## ğŸšï¸ Kota Sistemi

### Paket TanÄ±mlarÄ±

```javascript
// config/quotas.js
const QUOTAS = {
  BASIC: {
    monthly_tokens: 50_000,
    daily_limit: null,           // GÃ¼nlÃ¼k limit yok
    overage_allowed: false,      // AÅŸÄ±m engellenir
    alert_threshold: 0.8         // %80'de uyarÄ±
  },
  PREMIUM: {
    monthly_tokens: 500_000,
    daily_limit: 50_000,         // GÃ¼nlÃ¼k max
    overage_allowed: true,       // AÅŸÄ±m izinli (ek Ã¼cret)
    overage_rate: 0.0001,        // Token baÅŸÄ± TRY
    alert_threshold: 0.8
  },
  ENTERPRISE: {
    monthly_tokens: Infinity,
    daily_limit: null,
    overage_allowed: false,
    alert_threshold: null
  }
};
```

### Kota Kontrol AkÄ±ÅŸÄ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUOTA CHECK MIDDLEWARE                        â”‚
â”‚                                                                 â”‚
â”‚  function checkQuota(license_id) {                              â”‚
â”‚    const license = await getLicense(license_id);                â”‚
â”‚    const usage = await getCurrentMonthUsage(license_id);        â”‚
â”‚    const quota = QUOTAS[license.package_type];                  â”‚
â”‚                                                                 â”‚
â”‚    if (usage.total_tokens >= quota.monthly_tokens) {            â”‚
â”‚      if (!quota.overage_allowed) {                              â”‚
â”‚        throw new QuotaExceededError("AylÄ±k kota aÅŸÄ±ldÄ±");       â”‚
â”‚      }                                                          â”‚
â”‚      // Mark as overage billing                                 â”‚
â”‚      return { allowed: true, overage: true };                   â”‚
â”‚    }                                                            â”‚
â”‚                                                                 â”‚
â”‚    if (usage.today_tokens >= quota.daily_limit) {               â”‚
â”‚      throw new DailyLimitError("GÃ¼nlÃ¼k limit aÅŸÄ±ldÄ±");          â”‚
â”‚    }                                                            â”‚
â”‚                                                                 â”‚
â”‚    // Check alert threshold                                     â”‚
â”‚    const percentage = usage.total_tokens / quota.monthly_tokens;â”‚
â”‚    if (percentage >= quota.alert_threshold) {                   â”‚
â”‚      await sendQuotaAlert(license_id, percentage);              â”‚
â”‚    }                                                            â”‚
â”‚                                                                 â”‚
â”‚    return { allowed: true, overage: false };                    â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± KullanÄ±m Raporu API

### Endpoint: GET /api/v1/usage/my

**Request:**
```http
GET /api/v1/usage/my HTTP/1.1
Host: api.domizan.com
X-License-Key: DMZ-eyJ1c2...
```

**Response:**
```json
{
  "license_id": "DMZ-xyz",
  "package": "PREMIUM",
  "period": {
    "start": "2026-02-01",
    "end": "2026-02-28",
    "days_remaining": 23
  },
  "quota": {
    "monthly_limit": 500000,
    "used": 127500,
    "remaining": 372500,
    "percentage": 25.5
  },
  "today": {
    "limit": 50000,
    "used": 3200,
    "remaining": 46800
  },
  "cost": {
    "current_month_try": 4.85,
    "average_per_document": 0.038
  },
  "alerts": []
}
```

---

## âš ï¸ Hata SenaryolarÄ±

| Hata Kodu | Durum | KullanÄ±cÄ±ya Mesaj |
|-----------|-------|-------------------|
| `QUOTA_EXCEEDED` | AylÄ±k limit aÅŸÄ±ldÄ± | "Bu ay iÃ§in token kotanÄ±z doldu. Paketinizi yÃ¼kseltin." |
| `DAILY_LIMIT` | GÃ¼nlÃ¼k limit aÅŸÄ±ldÄ± | "BugÃ¼nkÃ¼ limitiniz doldu. YarÄ±n devam edebilirsiniz." |
| `LICENSE_EXPIRED` | Lisans sÃ¼resi dolmuÅŸ | "LisansÄ±nÄ±zÄ±n sÃ¼resi dolmuÅŸ. LÃ¼tfen yenileyin." |
| `LICENSE_INVALID` | Lisans geÃ§ersiz | "GeÃ§ersiz lisans. Destek ile iletiÅŸime geÃ§in." |

---

## ğŸ“ˆ Admin Dashboard Metrikleri

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN DASHBOARD                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“Š GENEL Ä°STATÄ°STÄ°KLER (Bu Ay)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Toplam      â”‚ Toplam      â”‚ Toplam      â”‚ Toplam      â”‚     â”‚
â”‚  â”‚ Ä°stek       â”‚ Token       â”‚ Maliyet     â”‚ MÃ¼ÅŸteri     â”‚     â”‚
â”‚  â”‚             â”‚             â”‚             â”‚             â”‚     â”‚
â”‚  â”‚   45.230    â”‚  226.5M     â”‚   $237.82   â”‚    156      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ˆ GÃœNLÃœK KULLANIM                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    â–„                                                     â”‚   â”‚
â”‚  â”‚   â–„â–ˆâ–„    â–„                                              â”‚   â”‚
â”‚  â”‚  â–„â–ˆâ–ˆâ–ˆâ–„  â–„â–ˆâ–„  â–„     â–„                                    â”‚   â”‚
â”‚  â”‚ â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–„â–ˆâ–ˆâ–ˆâ–„â–„â–ˆâ–„   â–„â–ˆâ–„                                   â”‚   â”‚
â”‚  â”‚ 01  02  03  04  05  06  07  08  ...                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ† EN Ã‡OK KULLANAN MÃœÅTERÄ°LER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ MÃ¼ÅŸteri                    â”‚ Token    â”‚ Maliyet  â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ Acero Muhasebe             â”‚ 12.5M    â”‚ $13.12   â”‚          â”‚
â”‚  â”‚ ABC Mali MÃ¼ÅŸavirlik        â”‚ 8.2M     â”‚ $8.61    â”‚          â”‚
â”‚  â”‚ XYZ Finans                 â”‚ 6.8M     â”‚ $7.14    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
